rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is teacher or principal
    function isTeacherOrPrincipal() {
      return getUserRole() == 'teacher' || getUserRole() == 'principal' || getUserRole() == 'admin';
    }
    
    // Helper function to check if user is student
    function isStudent() {
      return getUserRole() == 'student';
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isAuthenticated() && (request.auth.uid == userId || isTeacherOrPrincipal());
      
      // Users can create their own profile (during signup)
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can update their own profile
      // Teachers/Principals can update any user profile
      allow update: if isAuthenticated() && (request.auth.uid == userId || isTeacherOrPrincipal());
      
      // Only admins can delete user profiles
      allow delete: if isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Students collection
    match /students/{studentId} {
      // Students can read their own data
      // Teachers/Principals can read all student data
      allow read: if isAuthenticated() && (
        (isStudent() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.academicUnitId == resource.data.classId) ||
        isTeacherOrPrincipal()
      );
      
      // Only teachers/principals can create students
      allow create: if isAuthenticated() && isTeacherOrPrincipal();
      
      // Only teachers/principals can update students
      allow update: if isAuthenticated() && isTeacherOrPrincipal();
      
      // Only principals/admins can delete students
      allow delete: if isAuthenticated() && (getUserRole() == 'principal' || getUserRole() == 'admin');
    }
    
    // Teachers collection
    match /teachers/{teacherId} {
      // All authenticated users can read teachers
      allow read: if isAuthenticated();
      
      // Only principals/admins can create/update/delete teachers
      allow write: if isAuthenticated() && (getUserRole() == 'principal' || getUserRole() == 'admin');
    }
    
    // Subjects collection
    match /subjects/{subjectId} {
      // All authenticated users can read subjects
      allow read: if isAuthenticated();
      
      // Only teachers/principals can create/update subjects
      allow write: if isAuthenticated() && isTeacherOrPrincipal();
      
      // Only principals/admins can delete subjects
      allow delete: if isAuthenticated() && (getUserRole() == 'principal' || getUserRole() == 'admin');
    }
    
    // Academic units (classes) collection
    match /academic_units/{classId} {
      // All authenticated users can read classes
      allow read: if isAuthenticated();
      
      // Only principals/admins can create/update/delete classes
      allow write: if isAuthenticated() && (getUserRole() == 'principal' || getUserRole() == 'admin');
    }
    
    // Attendance collection
    match /attendance/{attendanceId} {
      // Students can read their own attendance
      // Teachers can read attendance for their classes
      // Principals can read all attendance
      allow read: if isAuthenticated() && (
        isStudent() ||
        (getUserRole() == 'teacher' && resource.data.teacherId == request.auth.uid) ||
        isTeacherOrPrincipal()
      );
      
      // Only teachers can create attendance
      allow create: if isAuthenticated() && getUserRole() == 'teacher';
      
      // Only teachers can update attendance (confirm, modify)
      allow update: if isAuthenticated() && (
        (getUserRole() == 'teacher' && resource.data.teacherId == request.auth.uid) ||
        getUserRole() == 'principal'
      );
      
      // Only principals/admins can delete attendance
      allow delete: if isAuthenticated() && (getUserRole() == 'principal' || getUserRole() == 'admin');
    }
    
    // Posts collection
    match /posts/{postId} {
      // All authenticated users can read posts
      allow read: if isAuthenticated();
      
      // Teachers/Principals can create posts
      allow create: if isAuthenticated() && isTeacherOrPrincipal();
      
      // Authors can update their own posts
      // Principals can update any post
      allow update: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid ||
        getUserRole() == 'principal'
      );
      
      // Authors and principals can delete posts
      allow delete: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid ||
        getUserRole() == 'principal'
      );
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

